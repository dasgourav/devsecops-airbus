version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto8

    commands:
      - yum install jq    
      - wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-3.0.0.702-linux.zip -P /opt
      - unzip /opt/sonar-scanner-cli-3.0.0.702-linux.zip -d /opt/
      - mv /opt/sonar-scanner-3.0.0.702-linux /opt/sonar-scanner-3.0
      - export PATH=/opt/sonar-scanner-3.0/bin:$PATH
      - ls -l /opt      
      - echo $CODEBUILD_SRC_DIR

  pre_build:
    commands:
      - sonar_host_url="$SONARQUBE_URL"
      - sonar_project_key="$REPOSITORY_NAME"
      - sonar_token="$SONARQUBE_TOKEN"

  build:
    commands:
      - result=$(sonar-scanner -Dsonar.projectKey=$sonar_project_key -Dsonar.sources=src -Dsonar.projectVersion=1.0 -Dsonar.projectName=SecurityqualityCheck -Dsonar.login=$sonar_token -Dsonar.host.url=$sonar_host_url)
      - echo $result

  post_build:
    commands:
      - sonar_link=$(echo $result | egrep -o "you can browse http://[^, ]+")
      - sonar_task_id=$(echo $result | egrep -o "task\?id=[^ ]+" | cut -d'=' -f2)
      - | # Allow time for SonarQube Background Task to complete
        stat="PENDING";
        while [ "$stat" != "SUCCESS" ]; do
          if [ $stat = "FAILED" ] || [ $stat = "CANCELLED" ]; then
            echo "SonarQube task $sonar_task_id failed";
            exit 1;
          fi
          stat=$(curl -u "$sonar_token:" $sonar_host_url/api/ce/task\?id=$sonar_task_id | jq -r '.task.status');
          echo "SonarQube analysis status is $stat";
          sleep 5;
        done
      - sonar_analysis_id=$(curl -u "$sonar_token:" $sonar_host_url/api/ce/task\?id=$sonar_task_id | jq -r '.task.analysisId')
      - quality_status=$(curl -u "$sonar_token:" $sonar_host_url/api/qualitygates/project_status\?analysisId=$sonar_analysis_id | jq -r '.projectStatus.status')
      - |
        if [ $quality_status = "ERROR" ]; then
          content=$(echo "SonarQube analysis complete. Quality Gate Failed.\n\nTo see why, $sonar_link");
        elif [ $quality_status = "OK" ]; then
          content=$(echo "SonarQube analysis complete. Quality Gate Passed.\n\nFor details, $sonar_link");
        else
          content="An unexpected error occurred while attempting to analyze with SonarQube.";
        fi

artifacts:
  files: 
   - '**/*'
  base-directory: '.scannerwork'